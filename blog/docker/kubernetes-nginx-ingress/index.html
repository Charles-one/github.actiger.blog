<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Kubernetes Ingress Nginx - AcTiger è·³è·³è™</title>
    
    <meta name="description" content="1. ä¸ºäº†ç†è§£Nginx Ingress Controller, å…ˆçœ‹ä¸‹ä¸Šæµ·é•¿å®æ¥ç¦å£«çš„äººè„¸è¯†åˆ«ç”µæ¢¯, æ­£å¥½åœ¨è¿™ä¸Šç­ğŸ˜ƒ. æŠŠå¤–éƒ¨è¿›å…¥å†…éƒ¨äººè„¸è¯†åˆ«é—¸æœºç±»æ¯”ä¸ºNGINX Ingress Controller, åŒ¹é…åŸŸå, æŠŠäººæˆ–è¯·æ±‚åˆ†é…åˆ°å†…éƒ¨service. æŠŠäººè„¸è¯†åˆ«åˆ†é…ç”µæ¢¯ç±»æ¯”ä¸ºservice, serviceæ§åˆ¶ç€ä¸€ç»„ç”µæ¢¯, å°†äººæˆ–è¯·æ±‚åˆ†é…serviceä¸‹çš„ç”µæ¢¯ä¸­. æŠŠç”µæ¢¯ç±»æ¯”ä¸ºpod, åœ¨serviceä¸‹, å¤„ç†äººæˆ–è¯·æ±‚. 2. ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶, è§’è‰²ä¸serviceç»‘å®šçš„, ä½¿ç”¨åˆ°pvå’Œpvc, ä½¿ç”¨secret, æˆ‘çš„å‘½åç©ºé—´æ˜¯nginx-space  åˆ›å»ºname-space  kubectl create namespace nginx-space è®¾ç½®é»˜è®¤è¿”å›å†…å®¹ default-backend.yaml  apiVersion: extensions/v1beta1 kind: Deployment metadata: name: default-http-backend labels: k8s-app: default-http-backend namespace: nginx-space spec: replicas: 1 template: metadata: labels: k8s-app: default-http-backend spec: terminationGracePeriodSeconds: 60 containers: - name: default-http-backend # Any image is permissable as long as: # 1. It serves a 404 page at / # 2.">
    <meta name="author" content="">
    
    <link href="https://leezicai.github.io/actiger/an-old-hope.min.css" rel="stylesheet">
    <link href="https://leezicai.github.io/actiger/style.css" rel="stylesheet">
    
    <link rel="icon" href="https://leezicai.github.io/actiger/favicon.ico">
    <meta name="generator" content="Hugo 0.84.1" />
    
    <link rel="alternate" type="application/atom+xml" href="https://leezicai.github.io/actiger/index.xml" title="AcTiger è·³è·³è™">
    
    
    <script>
      function setTheme() {
        const time = new Date();

        const prev = localStorage.getItem('date');
        const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

        const now = time.getTime();
        let sunrise;
        let sunset;

        function setBodyClass() {
          if (now > sunrise && now < sunset) return;
          document.body.classList.add('dark');
        }

        if (date !== prev) {
          fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215')
            .then(res => res.json())
            .then(data => {
              sunrise = data.sunrise.split(':').map(Number);
              sunset = data.sunset.split(':').map(Number);
            })
            .catch(() => {
              sunrise = [7, 0];
              sunset = [19, 0];
            })
            .finally(() => {
              sunrise = time.setHours(sunrise[0], sunrise[1], 0);
              sunset = time.setHours(sunset[0], sunset[1], 0);
              setBodyClass();
              localStorage.setItem('sunrise', sunrise);
              localStorage.setItem('sunset', sunset);
            });
          localStorage.setItem('date', date);
        } else {
          sunrise = Number(localStorage.getItem('sunrise'));
          sunset = Number(localStorage.getItem('sunset'));
          setBodyClass();
        }
      }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        <div class="div_center">
            <a >&nbsp&nbsp&nbsp&nbsp&nbsp</a>
            <a href="https://leezicai.github.io/actiger/"><img src="https://actiger.com/favicon.ico" width="32px" height="32px" alt="favicon" /></a>
            <p class="logo"><a href="https://leezicai.github.io/actiger/">AcTiger è·³è·³è™</a></p>
        </div>
        <ul class="menu">
          <li>
              <a href="https://leezicai.github.io/actiger/about">å…³äºæˆ‘</a>
          </li>
        </ul>
        
      </nav>
    </header>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Kubernetes Ingress Nginx</h1>
    <div class="post-meta">June 4, 2019</div>
  </header>
  <div class="post-content"><h3 id="1-ä¸ºäº†ç†è§£nginx-ingress-controller-å…ˆçœ‹ä¸‹ä¸Šæµ·é•¿å®æ¥ç¦å£«çš„äººè„¸è¯†åˆ«ç”µæ¢¯-æ­£å¥½åœ¨è¿™ä¸Šç­">1. ä¸ºäº†ç†è§£Nginx Ingress Controller, å…ˆçœ‹ä¸‹ä¸Šæµ·é•¿å®æ¥ç¦å£«çš„äººè„¸è¯†åˆ«ç”µæ¢¯, æ­£å¥½åœ¨è¿™ä¸Šç­ğŸ˜ƒ.</h3>
<p><img src="https://img.actiger.com/blog/tech/kubernetes-ingress-nginx.png" alt="é•¿å®æ¥ç¦å£«"></p>
<h4 id="æŠŠå¤–éƒ¨è¿›å…¥å†…éƒ¨äººè„¸è¯†åˆ«é—¸æœºç±»æ¯”ä¸ºnginx-ingress-controller-åŒ¹é…åŸŸå-æŠŠäººæˆ–è¯·æ±‚åˆ†é…åˆ°å†…éƒ¨service">æŠŠå¤–éƒ¨è¿›å…¥å†…éƒ¨äººè„¸è¯†åˆ«é—¸æœºç±»æ¯”ä¸ºNGINX Ingress Controller, åŒ¹é…åŸŸå, æŠŠäººæˆ–è¯·æ±‚åˆ†é…åˆ°å†…éƒ¨service.</h4>
<h4 id="æŠŠäººè„¸è¯†åˆ«åˆ†é…ç”µæ¢¯ç±»æ¯”ä¸ºservice-serviceæ§åˆ¶ç€ä¸€ç»„ç”µæ¢¯-å°†äººæˆ–è¯·æ±‚åˆ†é…serviceä¸‹çš„ç”µæ¢¯ä¸­">æŠŠäººè„¸è¯†åˆ«åˆ†é…ç”µæ¢¯ç±»æ¯”ä¸ºservice, serviceæ§åˆ¶ç€ä¸€ç»„ç”µæ¢¯, å°†äººæˆ–è¯·æ±‚åˆ†é…serviceä¸‹çš„ç”µæ¢¯ä¸­.</h4>
<h4 id="æŠŠç”µæ¢¯ç±»æ¯”ä¸ºpod-åœ¨serviceä¸‹-å¤„ç†äººæˆ–è¯·æ±‚">æŠŠç”µæ¢¯ç±»æ¯”ä¸ºpod, åœ¨serviceä¸‹, å¤„ç†äººæˆ–è¯·æ±‚.</h4>
<h3 id="2-ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶-è§’è‰²ä¸serviceç»‘å®šçš„-ä½¿ç”¨åˆ°pvå’Œpvc-ä½¿ç”¨secret-æˆ‘çš„å‘½åç©ºé—´æ˜¯nginx-space">2. ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶, è§’è‰²ä¸serviceç»‘å®šçš„, ä½¿ç”¨åˆ°pvå’Œpvc, ä½¿ç”¨secret, æˆ‘çš„å‘½åç©ºé—´æ˜¯nginx-space</h3>
<ol>
<li>åˆ›å»ºname-space</li>
</ol>
<pre><code>kubectl create namespace nginx-space
</code></pre><ol start="2">
<li>è®¾ç½®é»˜è®¤è¿”å›å†…å®¹ default-backend.yaml</li>
</ol>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: default-http-backend
  labels:
    k8s-app: default-http-backend
  namespace: nginx-space
spec:
  replicas: 1
  template:
    metadata:
      labels:
        k8s-app: default-http-backend
    spec:
      terminationGracePeriodSeconds: 60
      containers:
      - name: default-http-backend
        # Any image is permissable as long as:
        # 1. It serves a 404 page at /
        # 2. It serves 200 on a /healthz endpoint
        image: gcr.io/google_containers/defaultbackend:1.4
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          timeoutSeconds: 5
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 20Mi
      nodeSelector:
        kubernetes.io/hostname: cc2
---
apiVersion: v1
kind: Service
metadata:
  name: default-http-backend
  namespace: nginx-space
  labels:
    k8s-app: default-http-backend
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    k8s-app: default-http-backend
</code></pre><ol start="3">
<li>è®¾ç½®è§’è‰², è§’è‰²ç»‘å®šnginx-ingress-controller-rbac.yml</li>
</ol>
<pre><code>#apiVersion: v1
#kind: Namespace
#metadata:
#  name: nginx-ingress
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-ingress-serviceaccount
  namespace: nginx-space
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: nginx-ingress-clusterrole
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
      - endpoints
      - nodes
      - pods
      - secrets
    verbs:
      - list
      - watch
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes
    verbs:
      - get
  - apiGroups:
      - &quot;&quot;
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &quot;extensions&quot;
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - &quot;&quot;
    resources:
        - events
    verbs:
        - create
        - patch
  - apiGroups:
      - &quot;extensions&quot;
    resources:
      - ingresses/status
    verbs:
      - update
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: nginx-ingress-role
  namespace: nginx-space
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
      - pods
      - secrets
      - namespaces
    verbs:
      - get
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
    resourceNames:
      # Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;
      # Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;
      # This has to be adapted if you change either parameter
      # when launching the nginx-ingress-controller.
      - &quot;ingress-controller-leader-nginx&quot;
    verbs:
      - get
      - update
  - apiGroups:
      - &quot;&quot;
    resources:
      - configmaps
    verbs:
      - create
  - apiGroups:
      - &quot;&quot;
    resources:
      - endpoints
    verbs:
      - get
      - create
      - update
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: nginx-ingress-role-nisa-binding
  namespace: nginx-space
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: nginx-ingress-role
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: nginx-space
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: nginx-ingress-clusterrole-nisa-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nginx-ingress-clusterrole
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: nginx-space
</code></pre><ol start="4">
<li>è®¾ç½®nginx ingress controlleré…ç½®, nginx-ingress-controller.yaml</li>
</ol>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-ingress-controller
  labels:
    k8s-app: nginx-ingress-controller
  namespace: nginx-space
# for now change default
spec:
  replicas: 1
  template:
    metadata:
      namespace: nginx-space
      labels:
        k8s-app: nginx-ingress-controller
    spec:
      # hostNetwork makes it possible to use ipv6 and to preserve the source IP correctly regardless of docker configuration
      # however, it is not a hard dependency of the nginx-ingress-controller itself and it may cause issues if port 10254 already is taken on the host
      # that said, since hostPort is broken on CNI (https://github.com/kubernetes/kubernetes/issues/31307) we have to use hostNetwork where CNI is used
      # like with kubeadm
      # hostNetwork: true
      terminationGracePeriodSeconds: 60
      hostNetwork: true
      serviceAccountName: nginx-ingress-serviceaccount
      containers:
      - image: bitnami/nginx-ingress-controller
        name: nginx-ingress-controller
        readinessProbe:
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          timeoutSeconds: 1
        ports:
        - containerPort: 80
          hostPort: 80
        - containerPort: 443
          hostPort: 443
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        args:
        - /nginx-ingress-controller
        - --default-backend-service=$(POD_NAMESPACE)/default-http-backend
#        - --default-ssl-certificate=$(POD_NAMESPACE)/ingress-secret
      nodeSelector:
        kubernetes.io/hostname: cc2
</code></pre><ol start="4">
<li>è®¾ç½®ingress, my-nginx.yml</li>
</ol>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  namespace: nginx-space
  name: my-nginx
spec:
  tls:
  - hosts:
    - www.actiger.com
    secretName: ingress-secret
  rules:
  - host: www.actiger.com
    http:
      paths:
      - backend:
          serviceName: my-nginx
          servicePort: 80
</code></pre><ol start="5">
<li>åˆ›å»ºnginx deleployment, nginx-deployment.yaml, åˆ›å»ºNginx Service</li>
</ol>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: my-nginx
  namespace: nginx-space
spec:
  replicas: 1
  template:
    metadata:
      namespace: nginx-space
      labels:
        app: my-nginx
    spec:
      containers:
      - name: my-nginx
        image: nginx:1.16.0
        ports:
        - containerPort: 80
        volumeMounts:
        - mountPath: /usr/share/nginx/html
          name: www.actiger.com
      volumes:
      - name: www.actiger.com
        persistentVolumeClaim:
          claimName: pvc-blog
---
apiVersion: v1
kind: Service
metadata:
  name: my-nginx
  namespace: nginx-space
  labels:
    run: my-nginx
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    app: my-nginx

</code></pre><ol start="6">
<li>è®¾ç½®åŸŸåè¯ä¹¦, ä½¿ç”¨çš„letsencrypt, privkey.pemå’Œcert.pemè½¬æˆbase64</li>
</ol>
<h4 id="å¦‚æ²¡æœ‰è¯ä¹¦-åˆ é™¤my-nginxymlä¸­è¿™è¡Œsecretname-ingress-secretå³å¯">å¦‚æ²¡æœ‰è¯ä¹¦, åˆ é™¤my-nginx.ymlä¸­è¿™è¡ŒsecretName: ingress-secretå³å¯.</h4>
<pre><code>apiVersion: v1
data:
  tls.crt:
  tls.key:
kind: Secret
metadata:
  name: ingress-secret
  namespace: nginx-space
type: Opaque

</code></pre><ol start="7">
<li>åˆ›å»ºhugoæ–‡ä»¶å¤¹, ä½¿ç”¨pvå’Œpvcåˆ›å»ºç©ºé—´.</li>
</ol>
<h4 id="å¦‚ä¸ä½¿ç”¨pvå’Œpvc-éœ€è¦åœ¨nginx-deploymentyamlå¤–éƒ¨ç¡¬ç›˜æ›¿æ¢ä¸ºå…¶ä»–æ–¹å¼">å¦‚ä¸ä½¿ç”¨pvå’Œpvc, éœ€è¦åœ¨nginx-deployment.yamlå¤–éƒ¨ç¡¬ç›˜æ›¿æ¢ä¸ºå…¶ä»–æ–¹å¼.</h4>
<h4 id="åˆ›å»ºpv-pv-blogyaml">åˆ›å»ºpv, pv-blog.yaml</h4>
<pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-blog
  namespace: nginx-space
spec:
  capacity:
    storage: 300Mi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/root/www.actiger.com&quot;

</code></pre><h4 id="åˆ›å»ºpvc-pvc-blogyaml">åˆ›å»ºpvc, pvc-blog.yaml</h4>
<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-blog
  namespace: nginx-space
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: &quot;&quot;
  resources:
    requests:
      storage: 300Mi
</code></pre><h3 id="3-åˆ›å»ºæœåŠ¡">3. åˆ›å»ºæœåŠ¡</h3>
<h4 id="å¦‚éœ€æ›´æ”¹é‡Œé¢å†…å®¹-éœ€è¦å…ˆåˆ é™¤kubectl-delete--f--é˜²æ­¢ç”Ÿæˆæ²¡ä½¿ç”¨çš„pod-å¦‚æœ‰é”™è¯¯å‚è€ƒ-a-hrefhttpsactigercomblogdockerkuberneteså®‰è£…-target_blanké€šè¿‡æ—¥å¿—æ’æŸ¥a">å¦‚éœ€æ›´æ”¹é‡Œé¢å†…å®¹, éœ€è¦å…ˆåˆ é™¤kubectl delete -f * é˜²æ­¢ç”Ÿæˆæ²¡ä½¿ç”¨çš„pod. å¦‚æœ‰é”™è¯¯å‚è€ƒ <a href="https://actiger.com/blog/docker/kuberneteså®‰è£…/" target="_blank">é€šè¿‡æ—¥å¿—æ’æŸ¥</a></h4>
<pre><code>kubectl apply -f default-backend.yaml,ingress-secret.yml,my-nginx.yml,nginx-deployment.yaml,nginx-ingress-controller-rbac.yml,nginx-ingress-controller.yaml,pv-blog.yaml,pvc-blog.yaml

# æŸ¥çœ‹pods
kubectl get pods -n nginx-space

</code></pre><h3 id="4-è®¿é—®a-hrefhttpsactigercom-target_blankhttpsactigercoma-æ›¿æ¢ä½ çš„åœ°å€å°±å¯ä»¥å¯ä»¥hostsæŒ‡å®šè‡ªå·±çš„åŸŸå-è™šæ‹Ÿæœºipå¯¹åº”åˆ°åŸŸåä¸Š">4. è®¿é—®<a href="https://actiger.com/" target="_blank"><a href="https://actiger.com/">https://actiger.com/</a></a>, æ›¿æ¢ä½ çš„åœ°å€å°±å¯ä»¥(å¯ä»¥hostsæŒ‡å®šè‡ªå·±çš„åŸŸå, è™šæ‹Ÿæœºipå¯¹åº”åˆ°åŸŸåä¸Š).</h3>
</div>
  
</article></main>
<footer class="footer">

<div class="div_center">
<div class="div_footer">
    <a href="https://leezicai.github.io/actiger/">AcTiger</a>
</div>
<div class="div_footer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="div_footer">
    <a href=" https://gohugo.io/" rel="noopener" target="_blank"><img height="23" width="23" src="https://img.actiger.com/ico/other/hugo-favicon.png"></a>
</div>

<div class="div_footer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="div_footer">
    <a href=" https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank"><img height="23" width="23" src="https://img.actiger.com/ico/other/paper-favicon.ico"></a>
</div>

<div class="div_footer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div  class="div_footer">
    <a href="https://github.com/charles-one/" rel="noopener" target="_blank"><img height="23" width="23" src="https://img.actiger.com/ico/other/github-favicon.png"></a>
</div>

<div class="div_footer">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="div_footer">
    <a href="https://twitter.com/leezicai" rel="noopener" target="_blank"><img height="23" width="23" src="https://img.actiger.com/ico/other/twitter-favicon.png"></a>
</div>

</div>
</footer>

<footer class="footer_base">
</footer>

<script src="https://leezicai.github.io/actiger/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>
</html>

