<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Kubernetes Ingress Nginx - Actigerè·³è·³è™</title>
    
    <meta name="description" content="1. ä¸ºäº†ç†è§£Nginx Ingress Controller, å…ˆçœ‹ä¸‹ä¸Šæµ·é•¿å®æ¥ç¦å£«çš„äººè„¸è¯†åˆ«ç”µæ¢¯, æ­£å¥½åœ¨è¿™ä¸Šç­ğŸ˜ƒ. æŠŠå¤–éƒ¨è¿›å…¥å†…éƒ¨äººè„¸è¯†åˆ«é—¸æœºç±»æ¯”ä¸ºNGINX Ingress Controller, åŒ¹é…åŸŸå, æŠŠäººæˆ–è¯·æ±‚åˆ†é…åˆ°å†…éƒ¨service. æŠŠäººè„¸è¯†åˆ«åˆ†é…ç”µæ¢¯ç±»æ¯”ä¸ºservice, serviceæ§åˆ¶ç€ä¸€ç»„ç”µæ¢¯, å°†äººæˆ–è¯·æ±‚åˆ†é…serviceä¸‹çš„ç”µæ¢¯ä¸­. æŠŠç”µæ¢¯ç±»æ¯”ä¸ºpod, åœ¨serviceä¸‹, æŠŠäººæˆ–è¯·æ±‚è¿é€ç›®çš„åœ°. 2. ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶, è§’è‰²ä¸serviceç»‘å®šçš„, ä½¿ç”¨åˆ°pvå’Œpvc, ä½¿ç”¨secret, æˆ‘çš„å‘½åç©ºé—´æ˜¯nginx-space  åˆ›å»ºname-space
kubectl create namespace nginx-space  è®¾ç½®é»˜è®¤è¿”å›å†…å®¹ default-backend.yaml
apiVersion: extensions/v1beta1 kind: Deployment metadata: name: default-http-backend labels: k8s-app: default-http-backend namespace: nginx-space spec: replicas: 1 template: metadata: labels: k8s-app: default-http-backend spec: terminationGracePeriodSeconds: 60 containers: - name: default-http-backend # Any image is permissable as long as: # 1. It serves a 404 page at / # 2.">
    <meta name="author" content="">
    
    <link href="https://charles-one.github.io/actiger/css/github-gist.min.css" rel="stylesheet">
    <link href="https://charles-one.github.io/actiger/css/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://charles-one.github.io/actiger/img/apple-touch-icon.png">
    <link rel="icon" href="https://charles-one.github.io/actiger/img/favicon.ico">
    
    <meta name="generator" content="Hugo 0.55.5" />
    
    <link rel="alternate" type="application/atom+xml" href="https://charles-one.github.io/actiger/index.xml" title="Actigerè·³è·³è™">
    
    
  </head>
  <body class="single">
    <header class="header">
      <div class="wrap">
        
        <p class="logo"><a href="https://charles-one.github.io/actiger/">Actigerè·³è·³è™ </a></p>
        
        <button class="menu-toggle" type="button"></button>
      </div>
    </header>
    <nav class="nav">
    <ul class="menu">
      
      
    </ul>
    </nav>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Kubernetes Ingress Nginx</h1>
    <div class="post-meta">2019.6.4</div>
  </header>
  <div class="post-content">

<h3 id="1-ä¸ºäº†ç†è§£nginx-ingress-controller-å…ˆçœ‹ä¸‹ä¸Šæµ·é•¿å®æ¥ç¦å£«çš„äººè„¸è¯†åˆ«ç”µæ¢¯-æ­£å¥½åœ¨è¿™ä¸Šç­">1. ä¸ºäº†ç†è§£Nginx Ingress Controller, å…ˆçœ‹ä¸‹ä¸Šæµ·é•¿å®æ¥ç¦å£«çš„äººè„¸è¯†åˆ«ç”µæ¢¯, æ­£å¥½åœ¨è¿™ä¸Šç­ğŸ˜ƒ.</h3>

<p><img src="../../img/kubernetes-ingress-nginx.png" alt="æ¥ç¦å¹²" /></p>

<h4 id="æŠŠå¤–éƒ¨è¿›å…¥å†…éƒ¨äººè„¸è¯†åˆ«é—¸æœºç±»æ¯”ä¸ºnginx-ingress-controller-åŒ¹é…åŸŸå-æŠŠäººæˆ–è¯·æ±‚åˆ†é…åˆ°å†…éƒ¨service">æŠŠå¤–éƒ¨è¿›å…¥å†…éƒ¨äººè„¸è¯†åˆ«é—¸æœºç±»æ¯”ä¸ºNGINX Ingress Controller, åŒ¹é…åŸŸå, æŠŠäººæˆ–è¯·æ±‚åˆ†é…åˆ°å†…éƒ¨service.</h4>

<h4 id="æŠŠäººè„¸è¯†åˆ«åˆ†é…ç”µæ¢¯ç±»æ¯”ä¸ºservice-serviceæ§åˆ¶ç€ä¸€ç»„ç”µæ¢¯-å°†äººæˆ–è¯·æ±‚åˆ†é…serviceä¸‹çš„ç”µæ¢¯ä¸­">æŠŠäººè„¸è¯†åˆ«åˆ†é…ç”µæ¢¯ç±»æ¯”ä¸ºservice, serviceæ§åˆ¶ç€ä¸€ç»„ç”µæ¢¯, å°†äººæˆ–è¯·æ±‚åˆ†é…serviceä¸‹çš„ç”µæ¢¯ä¸­.</h4>

<h4 id="æŠŠç”µæ¢¯ç±»æ¯”ä¸ºpod-åœ¨serviceä¸‹-æŠŠäººæˆ–è¯·æ±‚è¿é€ç›®çš„åœ°">æŠŠç”µæ¢¯ç±»æ¯”ä¸ºpod, åœ¨serviceä¸‹, æŠŠäººæˆ–è¯·æ±‚è¿é€ç›®çš„åœ°.</h4>

<h3 id="2-ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶-è§’è‰²ä¸serviceç»‘å®šçš„-ä½¿ç”¨åˆ°pvå’Œpvc-ä½¿ç”¨secret-æˆ‘çš„å‘½åç©ºé—´æ˜¯nginx-space">2. ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶, è§’è‰²ä¸serviceç»‘å®šçš„, ä½¿ç”¨åˆ°pvå’Œpvc, ä½¿ç”¨secret, æˆ‘çš„å‘½åç©ºé—´æ˜¯nginx-space</h3>

<ol>
<li><p>åˆ›å»ºname-space</p>

<pre><code>kubectl create namespace nginx-space
</code></pre></li>

<li><p>è®¾ç½®é»˜è®¤è¿”å›å†…å®¹ default-backend.yaml</p>

<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
name: default-http-backend
labels:
k8s-app: default-http-backend
namespace: nginx-space
spec:
replicas: 1
template:
metadata:
  labels:
    k8s-app: default-http-backend
spec:
  terminationGracePeriodSeconds: 60
  containers:
  - name: default-http-backend
    # Any image is permissable as long as:
    # 1. It serves a 404 page at /
    # 2. It serves 200 on a /healthz endpoint
    image: gcr.io/google_containers/defaultbackend:1.4
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
        scheme: HTTP
      initialDelaySeconds: 30
      timeoutSeconds: 5
    ports:
    - containerPort: 8080
    resources:
      limits:
        cpu: 10m
        memory: 20Mi
      requests:
        cpu: 10m
        memory: 20Mi
  nodeSelector:
    kubernetes.io/hostname: cc2
---
apiVersion: v1
kind: Service
metadata:
name: default-http-backend
namespace: nginx-space
labels:
k8s-app: default-http-backend
spec:
ports:
- port: 80
targetPort: 8080
selector:
k8s-app: default-http-backend
</code></pre></li>

<li><p>è®¾ç½®è§’è‰², è§’è‰²ç»‘å®šnginx-ingress-controller-rbac.yml</p>

<pre><code>#apiVersion: v1
#kind: Namespace
#metadata:
#  name: nginx-ingress
---
apiVersion: v1
kind: ServiceAccount
metadata:
name: nginx-ingress-serviceaccount
namespace: nginx-space
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
name: nginx-ingress-clusterrole
rules:
- apiGroups:
  - &quot;&quot;
resources:
  - configmaps
  - endpoints
  - nodes
  - pods
  - secrets
verbs:
  - list
  - watch
- apiGroups:
  - &quot;&quot;
resources:
  - nodes
verbs:
  - get
- apiGroups:
  - &quot;&quot;
resources:
  - services
verbs:
  - get
  - list
  - watch
- apiGroups:
  - &quot;extensions&quot;
resources:
  - ingresses
verbs:
  - get
  - list
  - watch
- apiGroups:
  - &quot;&quot;
resources:
    - events
verbs:
    - create
    - patch
- apiGroups:
  - &quot;extensions&quot;
resources:
  - ingresses/status
verbs:
  - update
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
name: nginx-ingress-role
namespace: nginx-space
rules:
- apiGroups:
  - &quot;&quot;
resources:
  - configmaps
  - pods
  - secrets
  - namespaces
verbs:
  - get
- apiGroups:
  - &quot;&quot;
resources:
  - configmaps
resourceNames:
  # Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;
  # Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;
  # This has to be adapted if you change either parameter
  # when launching the nginx-ingress-controller.
  - &quot;ingress-controller-leader-nginx&quot;
verbs:
  - get
  - update
- apiGroups:
  - &quot;&quot;
resources:
  - configmaps
verbs:
  - create
- apiGroups:
  - &quot;&quot;
resources:
  - endpoints
verbs:
  - get
  - create
  - update
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
name: nginx-ingress-role-nisa-binding
namespace: nginx-space
roleRef:
apiGroup: rbac.authorization.k8s.io
kind: Role
name: nginx-ingress-role
subjects:
- kind: ServiceAccount
name: nginx-ingress-serviceaccount
namespace: nginx-space
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
name: nginx-ingress-clusterrole-nisa-binding
roleRef:
apiGroup: rbac.authorization.k8s.io
kind: ClusterRole
name: nginx-ingress-clusterrole
subjects:
- kind: ServiceAccount
name: nginx-ingress-serviceaccount
namespace: nginx-space
</code></pre></li>

<li><p>è®¾ç½®nginx ingress controlleré…ç½®, nginx-ingress-controller.yaml</p>

<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
name: nginx-ingress-controller
labels:
k8s-app: nginx-ingress-controller
namespace: nginx-space
# for now change default
spec:
replicas: 1
template:
metadata:
  namespace: nginx-space
  labels:
    k8s-app: nginx-ingress-controller
spec:
  # hostNetwork makes it possible to use ipv6 and to preserve the source IP correctly regardless of docker configuration
  # however, it is not a hard dependency of the nginx-ingress-controller itself and it may cause issues if port 10254 already is taken on the host
  # that said, since hostPort is broken on CNI (https://github.com/kubernetes/kubernetes/issues/31307) we have to use hostNetwork where CNI is used
  # like with kubeadm
  # hostNetwork: true
  terminationGracePeriodSeconds: 60
  hostNetwork: true
  serviceAccountName: nginx-ingress-serviceaccount
  containers:
  - image: bitnami/nginx-ingress-controller
    name: nginx-ingress-controller
    readinessProbe:
      httpGet:
        path: /healthz
        port: 10254
        scheme: HTTP
    livenessProbe:
      httpGet:
        path: /healthz
        port: 10254
        scheme: HTTP
      initialDelaySeconds: 10
      timeoutSeconds: 1
    ports:
    - containerPort: 80
      hostPort: 80
    - containerPort: 443
      hostPort: 443
    env:
      - name: POD_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
      - name: POD_NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
    args:
    - /nginx-ingress-controller
    - --default-backend-service=$(POD_NAMESPACE)/default-http-backend
#        - --default-ssl-certificate=$(POD_NAMESPACE)/ingress-secret
  nodeSelector:
    kubernetes.io/hostname: cc2
</code></pre></li>

<li><p>è®¾ç½®ingress, my-nginx.yml</p>

<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
namespace: nginx-space
name: my-nginx
spec:
tls:
- hosts:
- blog.actiger.com
secretName: ingress-secret
rules:
- host: blog.actiger.com
http:
  paths:
  - backend:
      serviceName: my-nginx
      servicePort: 80
</code></pre></li>

<li><p>åˆ›å»ºnginx deleployment, nginx-deployment.yaml, åˆ›å»ºNginx Service</p>

<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
name: my-nginx
namespace: nginx-space
spec:
replicas: 1
template:
metadata:
  namespace: nginx-space
  labels:
    app: my-nginx
spec:
  containers:
  - name: my-nginx
    image: nginx:1.16.0
    ports:
    - containerPort: 80
    volumeMounts:
    - mountPath: /usr/share/nginx/html
      name: blog-actiger-com
  volumes:
  - name: blog-actiger-com
    persistentVolumeClaim:
      claimName: pvc-blog
---
apiVersion: v1
kind: Service
metadata:
name: my-nginx
namespace: nginx-space
labels:
run: my-nginx
spec:
ports:
- port: 80
protocol: TCP
selector:
app: my-nginx

</code></pre></li>

<li><p>è®¾ç½®åŸŸåè¯ä¹¦, ä½¿ç”¨çš„letsencrypt, privkey.pemå’Œcert.pemè½¬æˆbase64</p></li>
</ol>

<h4 id="å¦‚æ²¡æœ‰è¯ä¹¦-åˆ é™¤my-nginx-ymlä¸­è¿™è¡Œsecretname-ingress-secretå³å¯">å¦‚æ²¡æœ‰è¯ä¹¦, åˆ é™¤my-nginx.ymlä¸­è¿™è¡ŒsecretName: ingress-secretå³å¯.</h4>

<pre><code>apiVersion: v1
data:
  tls.crt:
  tls.key:
kind: Secret
metadata:
  name: ingress-secret
  namespace: nginx-space
type: Opaque

</code></pre>

<ol>
<li>åˆ›å»ºhugoæ–‡ä»¶å¤¹, ä½¿ç”¨pvå’Œpvcåˆ›å»ºç©ºé—´.</li>
</ol>

<h4 id="å¦‚ä¸ä½¿ç”¨pvå’Œpvc-éœ€è¦åœ¨nginx-deployment-yamlå¤–éƒ¨ç¡¬ç›˜æ›¿æ¢ä¸ºå…¶ä»–æ–¹å¼">å¦‚ä¸ä½¿ç”¨pvå’Œpvc, éœ€è¦åœ¨nginx-deployment.yamlå¤–éƒ¨ç¡¬ç›˜æ›¿æ¢ä¸ºå…¶ä»–æ–¹å¼.</h4>

<h4 id="åˆ›å»ºpv-pv-blog-yaml">åˆ›å»ºpv, pv-blog.yaml</h4>

<pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-blog
  namespace: nginx-space
spec:
  capacity:
    storage: 300Mi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/root/blog.actiger.com&quot;

</code></pre>

<h4 id="åˆ›å»ºpvc-pvc-blog-yaml">åˆ›å»ºpvc, pvc-blog.yaml</h4>

<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-blog
  namespace: nginx-space
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: &quot;&quot;
  resources:
    requests:
      storage: 300Mi
</code></pre>

<h3 id="3-åˆ›å»ºæœåŠ¡">3. åˆ›å»ºæœåŠ¡</h3>

<h4 id="å¦‚éœ€æ›´æ”¹é‡Œé¢å†…å®¹-éœ€è¦å…ˆåˆ é™¤kubectl-delete-f-é˜²æ­¢ç”Ÿæˆæ²¡ä½¿ç”¨çš„pod-å¦‚æœ‰é”™è¯¯å‚è€ƒ-é€šè¿‡æ—¥å¿—æ’æŸ¥-https-blog-actiger-com-docker-kuberneteså®‰è£…">å¦‚éœ€æ›´æ”¹é‡Œé¢å†…å®¹, éœ€è¦å…ˆåˆ é™¤kubectl delete -f * é˜²æ­¢ç”Ÿæˆæ²¡ä½¿ç”¨çš„pod. å¦‚æœ‰é”™è¯¯å‚è€ƒ<a href="https://blog.actiger.com/docker/kuberneteså®‰è£…/">é€šè¿‡æ—¥å¿—æ’æŸ¥</a></h4>

<pre><code>kubectl apply -f default-backend.yaml,ingress-secret.yml,my-nginx.yml,nginx-deployment.yaml,nginx-ingress-controller-rbac.yml,nginx-ingress-controller.yaml,pv-blog.yaml,pvc-blog.yaml

# æŸ¥çœ‹pods
kubectl get pods -n nginx-space

</code></pre>

<h3 id="4-è®¿é—®-https-blog-actiger-com-https-blog-actiger-com-æ›¿æ¢ä½ çš„åœ°å€å°±å¯ä»¥-å¯ä»¥hostsæŒ‡å®šè‡ªå·±çš„åŸŸå-æŠŠè™šæ‹Ÿæœºipå¯¹åº”åˆ°åŸŸåä¸Š">4. è®¿é—®<a href="https://blog.actiger.com/">https://blog.actiger.com/</a>, æ›¿æ¢ä½ çš„åœ°å€å°±å¯ä»¥(å¯ä»¥hostsæŒ‡å®šè‡ªå·±çš„åŸŸå, æŠŠè™šæ‹Ÿæœºipå¯¹åº”åˆ°åŸŸåä¸Š).</h3>
</div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>

</main>
<footer class="footer">
  <span>&copy; 2019 Actigerè·³è·³è™</span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugoï¸ï¸</a>ï¸</span>
  <span>&middot;</span>
  <span>Themeï¸ <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper</a></span>
</footer>
<script src="https://charles-one.github.io/actiger/js/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://charles-one.github.io/actiger/js/highlight.min.js" data-no-instant></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  setMenuListener();

  InstantClick.on('change', function() {
    document.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightBlock(block);
    });
    setMenuListener();
  });

  function setMenuListener() {
    var menuToggle = document.querySelector('.menu-toggle');
    var body = document.querySelector('body');
    menuToggle.addEventListener('click', function() {
      body.classList.toggle('no-scroll');
    }, false);
  }
</script>
</body>
</html>

